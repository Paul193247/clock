const nums = {
  1: [
    [
      [7.5, 37.5],
      [3, 30],
      [3, 45],
      [6, 45],
    ],
    [
      [7.5, 37.5],
      [3, 0],
      [6, 45],
      [0, 30],
    ],
    [
      [7.5, 37.5],
      [7.5, 37.5],
      [0, 30],
      [0, 30],
    ],
    [
      [7.5, 37.5],
      [7.5, 37.5],
      [0, 30],
      [0, 30],
    ],
    [
      [7.5, 37.5],
      [7.5, 37.5],
      [0, 30],
      [0, 30],
    ],
    [
      [7.5, 37.5],
      [7.5, 37.5],
      [0, 15],
      [0, 45],
    ],
  ],
  2: [
    [
      [3, 30],
      [3, 45],
      [3, 45],
      [6, 45],
    ],
    [
      [3, 0],
      [3, 45],
      [6, 45],
      [0, 30],
      [7.5, 37.5],
    ],
    [
      [7.5, 37.5],
      [7.5, 37.5],
      [0, 37.5],
      [0, 37.5],
    ],
    [
      [7.5, 37.5],
      [1.5, 37.5],
      [1, 37.5],
      [7.5, 37.5],
    ],
    [
      [6, 7.5],
      [3, 7.5],
      [3, 45],
      [6, 45],
    ],
    [
      [3, 0],
      [3, 45],
      [3, 45],
      [0, 45],
    ],
  ],
  3: [
    [
      [3, 30],
      [3, 45],
      [3, 45],
      [6, 45],
    ],
    [
      [3, 0],
      [3, 45],
      [6, 45],
      [0, 30],
    ],
    [
      [3, 30],
      [3, 45],
      [0, 45],
      [0, 30],
    ],
    [
      [3, 0],
      [3, 45],
      [6, 45],
      [0, 30],
    ],
    [
      [3, 30],
      [3, 45],
      [0, 45],
      [0, 30],
    ],
    [
      [3, 0],
      [3, 45],
      [3, 45],
      [0, 45],
    ],
  ],
  4: [
    [
      [3, 30],
      [6, 45],
      [7.5, 37.5],
      [7.5, 37.5],
    ],
    [
      [0, 30],
      [0, 30],
      [3, 30],
      [45, 30],
    ],
    [
      [0, 30],
      [0, 15],
      [0, 45],
      [0, 30],
    ],
    [
      [0, 15],
      [3, 45],
      [6, 45],
      [0, 30],
    ],
    [
      [7.5, 37.5],
      [7.5, 37.5],
      [0, 30],
      [0, 30],
    ],
    [
      [7.5, 37.5],
      [7.5, 37.5],
      [0, 15],
      [0, 45],
    ],
  ],
  5: [
    [
      [3, 30],
      [3, 45],
      [3, 45],
      [6, 45],
    ],
    [
      [0, 30],
      [3, 30],
      [3, 45],
      [0, 45],
    ],
    [
      [0, 30],
      [0, 15],
      [4, 45],
      [7.5, 37.5],
    ],
    [
      [0, 15],
      [3, 45],
      [6, 45],
      [6, 55],
    ],
    [
      [3, 30],
      [3, 45],
      [0, 45],
      [0, 30],
    ],
    [
      [0, 15],
      [3, 45],
      [3, 45],
      [0, 45],
    ],
  ],
  6: [
    [
      [7.5, 37.5],
      [3, 40],
      [3, 45],
      [6, 45],
    ],
    [
      [6, 5],
      [3, 30],
      [3, 45],
      [0, 45],
    ],
    [
      [0, 30],
      [0, 15],
      [4, 45],
      [7.5, 37.5],
    ],
    [
      [0, 30],
      [3, 30],
      [6, 45],
      [6, 55],
    ],
    [
      [0, 25],
      [0, 15],
      [0, 45],
      [0, 35],
    ],
    [
      [7.5, 37.5],
      [3, 50],
      [2, 45],
      [7.5, 37.5],
    ],
  ],
  7: [
    [
      [3, 30],
      [3, 45],
      [3, 45],
      [6, 45],
    ],
    [
      [0, 15],
      [3, 45],
      [6, 45],
      [0, 30],
    ],
    [
      [7.5, 37.5],
      [7.5, 37.5],
      [0, 37.5],
      [0, 37.5],
    ],
    [
      [7.5, 37.5],
      [2, 37.5],
      [2, 37.5],
      [7.5, 37.5],
    ],
    [
      [1, 30],
      [1, 30],
      [7.5, 37.5],
      [7.5, 37.5],
    ],
    [
      [0, 15],
      [0, 45],
      [7.5, 37.5],
      [7.5, 37.5],
    ],
  ],
  8: [
    [
      [7.5, 37.5],
      [3, 40],
      [4, 45],
      [7.5, 37.5],
    ],
    [
      [1, 30],
      [3, 30],
      [6, 45],
      [6, 55],
    ],
    [
      [0, 30],
      [0, 15],
      [0, 45],
      [0, 30],
    ],
    [
      [0, 30],
      [3, 30],
      [6, 45],
      [0, 30],
    ],
    [
      [0, 25],
      [0, 15],
      [0, 45],
      [0, 35],
    ],
    [
      [7.5, 37.5],
      [3, 50],
      [2, 45],
      [7.5, 37.5],
    ],
  ],
  9: [
    [
      [7.5, 37.5],
      [3, 40],
      [4, 45],
      [7.5, 37.5],
    ],
    [
      [1, 30],
      [3, 30],
      [6, 45],
      [6, 55],
    ],
    [
      [0, 25],
      [0, 15],
      [0, 45],
      [0, 30],
    ],
    [
      [7.5, 37.5],
      [3, 50],
      [6, 45],
      [0, 30],
    ],
    [
      [7.5, 37.5],
      [7.5, 37.5],
      [0, 30],
      [0, 30],
    ],
    [
      [7.5, 37.5],
      [7.5, 37.5],
      [0, 15],
      [0, 45],
    ],
  ],
  0: [
    [
      [7.5, 37.5],
      [3, 40],
      [4, 45],
      [7.5, 37.5],
    ],
    [
      [1, 30],
      [3, 30],
      [6, 45],
      [6, 55],
    ],
    [
      [0, 30],
      [0, 30],
      [0, 30],
      [0, 30],
    ],
    [
      [0, 30],
      [0, 30],
      [0, 30],
      [0, 30],
    ],
    [
      [0, 25],
      [0, 15],
      [0, 45],
      [0, 35],
    ],
    [
      [7.5, 37.5],
      [3, 50],
      [2, 45],
      [7.5, 37.5],
    ],
  ],
};

const animationEngine = {
  animations: [],
  isRunning: false,

  add(animation) {
    this.animations.push(animation);
    if (!this.isRunning) {
      this.start();
    }
  },

  start() {
    this.isRunning = true;
    const step = (now) => {
      // Batch-Update aller Animationen in einem Frame
      this.animations = this.animations.filter((anim) => {
        const elapsed = now - anim.startTime;
        const t = Math.min(elapsed / anim.duration, 1);
        const eased = this.easeInOutCubic(t);

        const h = anim.startH + anim.deltaH * Math.min(eased / 0.95, 1);
        const m = anim.startM + anim.totalDeltaM * eased;

        anim.clock.hour_hand.style.transform = `rotate(${h % 360}deg)`;
        anim.clock.minute_hand.style.transform = `rotate(${m % 360}deg)`;

        if (t >= 1) {
          anim.clock.hour_hand.style.transform = `rotate(${anim.endH}deg)`;
          anim.clock.minute_hand.style.transform = `rotate(${anim.endM}deg)`;
          return false;
        }
        return true;
      });

      if (this.animations.length > 0) {
        requestAnimationFrame(step);
      } else {
        this.isRunning = false;
      }
    };
    requestAnimationFrame(step);
  },

  easeInOutCubic(t) {
    return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
  },
};

function create_clock() {
  const clock = document.createElement("div");
  clock.className = "clock";

  const dot = document.createElement("div");
  dot.className = "dot";
  clock.append(dot);

  const inner_div = document.createElement("div");
  clock.append(inner_div);

  const hour_hand = document.createElement("div");
  hour_hand.className = "hour-hand";
  inner_div.append(hour_hand);

  const minute_hand = document.createElement("div");
  minute_hand.className = "minute-hand";
  inner_div.append(minute_hand);

  set_clock({ clock, hour_hand, minute_hand }, { hours: 7.5, minutes: 37.5 });
  return { clock, hour_hand, minute_hand };
}

function set_clock(clock, d) {
  const hDeg = d.hours * 30;
  const mDeg = d.minutes * 6;
  clock.hour_hand.style.transform = `rotate(${hDeg}deg)`;
  clock.minute_hand.style.transform = `rotate(${mDeg}deg)`;
}

function animate_clock(clock, targetTime, duration = 60000, delay = 10) {
  const start = get_current_time(clock);
  const startH = (start.hours % 12) * 30;
  const startM = start.minutes * 6;
  const endH = (targetTime.hours % 12) * 30;
  const endM = targetTime.minutes * 6;

  const deltaH = ((endH - startH + 360) % 360) + 360;
  const deltaM_phase1 = deltaH * 60;
  const deltaM_phase2 = (endM - ((startM + deltaM_phase1) % 360) + 360) % 360;
  const totalDeltaM = deltaM_phase1 + deltaM_phase2;

  setTimeout(() => {
    animationEngine.add({
      clock,
      startTime: performance.now(),
      duration, // Alle verwenden die gleiche Duration fÃ¼r gleiche Geschwindigkeit
      startH,
      startM,
      endH,
      endM,
      deltaH,
      totalDeltaM,
    });
  }, delay);
}

function create_clock_grid(xCount, yCount) {
  const grid = document.createElement("div");
  grid.className = "clock-grid";
  grid.style.gridTemplateColumns = `repeat(${xCount}, 1fr)`;
  grid.style.gridTemplateRows = `repeat(${yCount}, 1fr)`;
  document.body.append(grid);

  const res = Array.from({ length: yCount }, () =>
    Array.from({ length: xCount }, () => {
      const clock = create_clock();
      grid.append(clock.clock);
      return clock;
    })
  );
  return res;
}

const pos_offsets = { 1: 0, 2: 4, 3: 9, 4: 13 };

function set_num(grid, pos, num) {
  const digit = nums[num];
  const offset = pos_offsets[pos];

  for (let y = 0; y < 6; y++) {
    const row = grid[y + 1];
    const pattern = digit[y];
    for (let i = 0; i < 4; i++) {
      const [h, m] = pattern[i];
      const randomDelay = Math.random() * 800;
      animate_clock(
        row[i + offset],
        { hours: h, minutes: m },
        30000,
        randomDelay
      );
    }
  }

  const topRow = grid[0],
    bottomRow = grid[7];
  for (let y = 0; y < 17; y++) {
    const randomDelay = Math.random() * 800;
    animate_clock(topRow[y], { hours: 7.5, minutes: 37.5 }, 30000, randomDelay);
    animate_clock(
      bottomRow[y],
      { hours: 7.5, minutes: 37.5 },
      30000,
      randomDelay
    );
  }
  for (let y = 0; y < 6; y++) {
    const randomDelay = Math.random() * 800;
    animate_clock(
      grid[y + 1][8],
      { hours: 7.5, minutes: 37.5 },
      30000,
      randomDelay
    );
  }
}

function get_current_time(clock) {
  const parseDeg = (el) =>
    Number.parseFloat(el.style.transform.slice(7, -4)) || 0;
  return {
    hours: parseDeg(clock.hour_hand) / 30,
    minutes: parseDeg(clock.minute_hand) / 6 + 1,
  };
}

const grid = create_clock_grid(17, 8);
let lastTime = "";

function loop() {
  const time = new Date();
  const hh = time.getHours();
  const mm = time.getMinutes();
  const hhmm = `${hh}:${mm}`;

  if (hhmm !== lastTime) {
    set_num(grid, 1, Math.floor(hh / 10));
    set_num(grid, 2, hh % 10);
    set_num(grid, 3, Math.floor(mm / 10));
    set_num(grid, 4, mm % 10);
    lastTime = hhmm;
  }

  setTimeout(loop, 500);
}

loop();
